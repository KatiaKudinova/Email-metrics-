SELECT distinct
sent_month,
id_account,
sent_per_month_account/sent_per_month*100 as sent_msg_percent_from_this_month,
first_sent_date,
last_sent_date
FROM(
SELECT
qw.id_account,
count (id_message) over (partition by DATE_TRUNC(date_add(er.date, interval qw.sent_date day), month), qw.id_account) as  sent_per_month_account,
COUNT(id_message) over (partition by DATE_TRUNC(date_add(er.date, interval qw.sent_date day), month)) AS sent_per_month,
DATE_TRUNC(date_add(er.date, interval qw.sent_date day), month) as sent_month,
MIN(date_add(er.date, interval qw.sent_date day)) over (partition by DATE_TRUNC(date_add(er.date, interval qw.sent_date day), month) order by DATE_TRUNC(date_add(er.date, interval qw.sent_date day), month)) as first_sent_date,
MAX(date_add(er.date, interval qw.sent_date day)) over (partition by DATE_TRUNC(date_add(er.date, interval qw.sent_date day), month) order by DATE_TRUNC(date_add(er.date, interval qw.sent_date day), month)) as last_sent_date
FROM
`DA.email_sent` qw
join `DA.account_session` we
on qw.id_account = we.account_id
join `DA.session` er
on we.ga_session_id = er.ga_session_id
) date_new;
